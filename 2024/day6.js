function countVisited(input) {
  const visited = new Set();
  for (const state of walk(...getLayout(input))) {
    const position = Math.trunc(state / 4);
    visited.add(position);
  }
  return visited.size;
}

function countLoops(input) {
  const [width, height, layout, start] = getLayout(input);

  const placeCrate = (i, j) => {
    const assignment = new Map();
    let target = -1;
    assignment.set(4 * (i * width + j) + 0, target);
    assignment.set(4 * (i * width + j) + 1, target);
    assignment.set(4 * (i * width + j) + 2, target);
    assignment.set(4 * (i * width + j) + 3, target);
    target = 4 * ((i - 1) * width + j) + 4;
    for (let ii = i - 1; ii >= 0; ii--) {
      if (layout[ii * width + j]) break;
      assignment.set(4 * (ii * width + j) + 2, target);
    }
    target = 4 * (i * width + (j + 1)) + 1;
    for (let jj = j + 1; jj < width; jj++) {
      if (layout[i * width + jj]) break;
      assignment.set(4 * (i * width + jj) + 3, target);
    }
    target = 4 * ((i + 1) * width + j) + 2;
    for (let ii = i + 1; ii < height; ii++) {
      if (layout[ii * width + j]) break;
      assignment.set(4 * (ii * width + j) + 0, target);
    }
    target = 4 * (i * width + (j - 1)) + 3;
    for (let jj = j - 1; jj >= 0; jj--) {
      if (layout[i * width + jj]) break;
      assignment.set(4 * (i * width + jj) + 1, target);
    }
    return assignment;
  }

  const nextState = new Int32Array(layout.length * 4);
  for (let i = 0; i < height; i++) {
    for (let j = 0; j < width; j++) {
      if (layout[i * width + j]) {
        for (const [from, to] of placeCrate(i, j)) {
          nextState[from] = to;
        }
      }
    }
  }

  const tested = new Set();
  tested.add(start);
  let count = 0;
  for (const state of walk(width, height, layout, start)) {
    const position = Math.trunc(state / 4);
    if (tested.has(position)) {
      continue;
    }
    tested.add(position);
    const altered = placeCrate(Math.trunc(position / width), position % width);
    for (const [from, to] of altered) {
      const before = nextState[from];
      nextState[from] = to;
      altered.set(from, before);
    }

    const visited = new Set();
    let curr = 4 * start;
    while (curr >= 0) {
      if (visited.has(curr)) {
        count++;
        break;
      }
      visited.add(curr);
      curr = nextState[curr] - 1;
    }
    
    for (const [from, to] of altered) {
      nextState[from] = to;
    }
  }
  return count;
}

function getLayout(input) {
  const width = input[0].length;
  const height = input.length;
  const size = width * height;
  const layout = new Uint8Array(size);
  let start = -1;
  for (let i = 0; i < height; i++) {
    for (let j = 0; j < width; j++) {
      if (input[i][j] === '^') {
        start = i * width + j;
      } else if (input[i][j] === '#') {
        layout[i * width + j] = 1;
      }
    }
  }
  return [width, height, layout, start];
}

function* walk(width, height, layout, start) {
  let position = start;
  let direction = 0;
  while (position >= 0) {
    yield position * 4 + direction;
    const x = position % width;
    if (direction === 0) {
      if (position < width) {
        position = -1;
      } else if (layout[position - width]) {
        direction = 1;
      } else {
        position -= width;
      }
    } else if (direction === 1) {
      if (x === width - 1) {
        position = -1;
      } else if (layout[position + 1]) {
        direction = 2;
      } else {
        position += 1;
      }
    } else if (direction === 2) {
      if (position >= width * (height - 1)) {
        position = -1;
      } else if (layout[position + width]) {
        direction = 3;
      } else {
        position += width;
      }
    } else if (direction === 3) {
      if (x === 0) {
        position = -1;
      } else if (layout[position - 1]) {
        direction = 0;
      } else {
        position -= 1;
      }
    }
  }
}

const test = `
........#........................................#......#........#................................................................
....................................#......#.....#............#.............#..........#..........................................
......................#.......................................................#...................................................
.......#..#..#....#...#...#....#..............#......#.......#...#................#.......#.......................................
......................#....##...#.......#....#.......................................#....................#.......................
...#............................#........................................#..........................#.....................#.......
....................#............#...............#......#.........#...........#...................................................
............................#......#...#................#.............#...........................................................
.....#..#.........#....................#......................................................#........................#.........#
.........#..##.#.........#.............................................#...........#........#....................##...............
...............#....#.........................##......#.....................#..............................................#......10
..................##...................................#...........#........#....#.............#..................#........#.#....
....................................#...................#..............................#............#.............................
.........#.....#................#..........................................#...................................#..............#...
...#....................#...................................#..##...................#.......#......................###.........#..
....................#............#....#.##....#.........#......#...#........................#.......................#..........#..
..............#...................................................................................#....................#..........
.........#................#..............................#............................#...#.................#...............#.....
............................................................................................#...#............................#....
............#....................#................................#....#...............................#....#.....................
........................................#.........#..................................................#..#..................#......20
.............#.#............................#..#.....#............................................#....#..........................
................................................................................................#.........#..#..............#..#..
...........#..........#.#..#................#.#..#...#.........#..........................................#..........#..#.........
.............................#....................#.......#....#.....#....#......#....................#..#...............##.......
..........#..............................................................................#....#.........#..#................#.....
..#..#...............................................................#.......#........#...........................#...............
...........................................................................#...##....................#.#....##....................
.......................................#...............................................#.....................#.........#..........
.......................................................#.......#....#................#.....................................#......
.............#................#...................#.................#....................#..................#.#.........#.........30
.....................................................................#.....................................#......................
........................#..........................................#....#..#.#..........................................#.........
............#.......#..................#.................................................#..............#.......................#.
.........................................................#...............#...#....#...........#.................................#.
.........................#..........................#..#........................................................#.................
...............#....................................#.......#......................................#............#.................
.#......................................................................................................#.........................
#...#........................................................#.................#....#....................#...........#............
..#.........#................................................................#................................#.............#.....
..................................#.........................................................................#................#....40
..............#..............................................#........#..................................#........................
......#............................................#.................................#............................#...............
.......##..#.......................##............#...#...................#.#..........................................##..........
.#......#.....................................................................#..#..........................#......#.............#
.................#.....................#........##..#.........#........#................#.........................................
...........#.....#..........#........#............................................................................................
.........................#......#.......................................#..............................#..........................
............#............................................................#..............#..............................#..........
..................#.........#...........................................................................................#.........
#.#..................................#....................#......................#.............#.................................#50
....#................#.................#...................#...........#......................................#...................
................#........................................................................................#....#.#.......#.....##..
..........#...#.......................................#........#.......................................#...#......................
.......#..##........................#......##.........................#.........#.......#.............................#.....#.....
................#...............................................#....#..........#.....#.........#.........#.........#.............
...............................#............#....................................#......#......................................#..
.#..#..................#............................................#....#............#...............##...#..........#...........
....#.............................................................................................................................
.............................................................#...........................#..........#.............................
.#........#..................#.....#.............#.....................................................#...#........#...........#.60
.......................#........................................#.....#............................#.#..................#.........
................#....#................#.......#............................#.......#.................#............................
....#.........#....#........#.....................#........................#............#.........................................
.......#.......#.....................................................................##...........#...............................
...........#.........................................................#..........#............#....................................
..................#.............................#.......................................................................#.........
................#.....#........#.....#...#..........#.....................................#.....#........................#........
..........................................#.........#...........#.................................................................
...#.......................................................................................................#......................
....#..............#...........#..................................................#.................#.................#...........70
.#................#.....#.#.................................................................#.........................#...........
............#.........................##....................................#..............#......................................
...##...........#...#............#..........................................................................#.....................
............................................#......................#......#.......................................................
............#............................................................................................................#........
...................##..............#.#....#.##...................................................#..................#.............
..#...................................................................................#.........#.........................#.....#.
........................#..............................................#......#................................................#..
................#............#............................#.#...................#.....................#...........................
..................#......#................#.#......................#...................#...#......................................80
..#................................................##...................................................................#.........
...........................#......................................................................#......#...#......#.............
........................#...#........#......#.......#..........#.............................#........#.....#.....................
.................................................#..............................................#......#.....#....................
.....#....#.................#......#........#.#..............^...........................#...................#..#.................
.............................................................................#................................#...................
#..........................#..#..............#.......#..........................#.................................................
............#.............................................................................#...................#...................
..................#.............................#.........................................#................#.........#......#.....
...#...............................#.....#......#............###.#.#.....................................#....#.............#.....90
...........#...........#...........................#..............................................................................
............#..........................................#.....#.............#..........................#....................#.....#
........................#......#..#............................#.......................................................#..........
..#...#...#.......#.#..........................................#.............#.........#....#..................#...........#......
..................#.......#.....................................................................................#........#........
......##................#...........................................#..............##.................................#...........
.................#................................................................................#.#....................#........
....................#.........#..........#...............#...#...#.#.#............................................................
#..................#.#..........#..#...................................................................................#..........
..........#........................................................#..........##..........................#..##...................100
...........#...................................................................#..................................................
..................#........#............................................#..................#....#.......................#..#......
............#...................#......#..........................................................................................
...........................#.....##..........#.#..............#......................#.............#.......#...........#..........
............#..................................................#.......#.........#.#..................#..............##...........
#..................................................#...#......#..#......................#.............#........#............#.....
....#..................#..........#.........#.........................................#..................#................#.......
...#.................#.............................................................................#....................#.........
..........#.................................................................#............#....................#.#.#.....#.........
.....................#......................#...........#........#................................................................110
.....#.......................................................................#......................#...#......#..................
.............##........#.....................#...........##........#............#.....#.....................#...............#.....
.....#.........#....#.................#....#...........#.......##..........#.........#.#......................................#...
.......#..................##.......#...#.#...#...................................#.......................................#.....#..
...............#.......#.................#........................................................................................
......#.......#.....#...............................#...........#.......#......................##...#....#........................
.##..........................##..................##................#..#....#...##.................................................
........#..............................#.#......#........#...............#....#........#.#........................................
...............................#..#.....................#.#...................#...................................................
.....................#.................................................##...#.......#.................##...............#.......#..120
.............#..........................#.................................#..............#.......#..........#........#............
.........................................#...................#.........................................................#..........
...............................#..........#..............................#............#.....#.....................................
.............#..........................#....................#................................#...#............#..................
....#......#........#.......#......#................................................#...#......................................##.
..#...................................#........#.....................................#...#......#.........#..#..........#.........
.......#.........#................................................................................................................
...........#...............................##.........................................#..#....................#.....#.#.......##..
.........................#..#...............#............................#.............#..........................#..............#
`.trim().split('\n');

console.log(countVisited(test));
console.log(countLoops(test));
