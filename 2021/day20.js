const FILTER = [
  [-1, -1],
  [0, -1],
  [1, -1],
  [-1, 0],
  [0, 0],
  [1, 0],
  [-1, 1],
  [0, 1],
  [1, 1]
]

function countLitPixel (input, algo, steps = 2) {
  const n = input.length
  const m = input[0].length
  let image = Object.create(null)
  for (let j = 0; j < n; j++) {
    for (let i = 0; i < m; i++) {
      image[`${i},${j}`] = input[j][i] === '#' ? 1 : 0
    }
  }
  let buffer = 0
  let unseen = 0
  while (buffer++ < steps) {
    image = applyAlgo(image, n, m, algo, buffer, unseen)
    if (algo[0]) unseen = 1 - unseen
  }
  // printImage(image, n, m, 2, buffer)
  return Object.values(image).reduce((sum, v) => sum + v, 0)
}

function applyAlgo (image, n, m, algo, buffer, unseen = 0) {
  const updated = Object.create(null)
  for (let j = -buffer; j < n + buffer; j++) {
    for (let i = -buffer; i < m + buffer; i++) {
      const index = FILTER.reduce((sum, offset) => {
        const v = image[`${i + offset[0]},${j + offset[1]}`] ?? unseen
        return 2 * sum + v
      }, 0)
      updated[`${i},${j}`] = algo[index] === '#' ? 1 : 0
    }
  }
  return updated
}

function printImage (image, n, m, buffer = 0) {
  for (let j = -buffer; j < n + buffer; j++) {
    let line = ''
    for (let i = -buffer; i < m + buffer; i++) {
      line += image[`${i},${j}`] ? '#' : '.'
    }
    console.log(line)
  }
}

const algo = '#....##..##...####...##.#..####..#.#.#.#..##....##....#.....#.##....##..###.#..####.#..#.###...##....##...#.#####..#.....#.#####.##....##..#.#####.....#.....###..#.#.###...###..#..#.#.#####....#.#..#..##..#.####.###.#.#...##.##.#.###...#####......#.........##.#.#####.##.##........#..#.##.####.#...#..#####.####.#.##.####.#.#.##.#..#..#.#....#.###.#.###.#......#..#...#.#..#..###..#....####...##....##.#..###...##.##.####..#..#..#..#.#...###.#.##.##.#..####.#.#..#....####......##.###.####..###.....##..##..##...'

const test = `
.#...##.#...#.##.#.....#..###...#.##.##...##.##.##.###...##.#.#...#..##..###.....#..##...#....#.####
##.#####..#.#...##.#..##..#.#.######...#.##.#...#...##.#...#.#.#......#.#####.....#.######.....#...#
....#..###..#.###.####....##.#...#...##.###.###...#...####.#.......#########.####.#.#..###.##..###..
.#..#.##.###...#.##...#.....#.#.#...##....##.......####...#...####.####.#...#..#..##..###.#..#.#....
..#.###..##.......#.##...##..#...####.####.##..#####.#..#.####..#....#..##..##....##.##...#.......#.
#.#.#..#.####..###..#..#..##.#...#.#..###.##..#.##.###.##..#.......##.###.#..###.####..#####.....#..
#.#...#..#.##..#.###...###.#....#...#..###.#.#..####.#..#.#.#.#..###.####.......#.#..#.####...###..#
###.#.##.#..#.##.#.#....###...##..#.##.#.##..####...##.#.#....###.#.###.##.#.#####..#....#......##..
.#.#..##.#.###..#..#.####.######.########....##.#.#.###.#..#...#.##.##..#.#.##.####.####.#.###...##.
.#..#...#####..##..##..#.#.##.#######...####...#..#.###..#.#####..#..#...#..###...#.##....#.###..#..
##...####.....###.#....##..#...#...##..#.#..##.####..#.##.#..##.##.#...##.##..##.##.#.##.##.####.#.#
#...#.#.#..#......#.#.##.#.##.#......#.....#####..#.###.##.##.###..#.#.###..#####...#.#....###.#.#..
..##.##.#.#.#..#######.##..#...##.....#..#.##.#...#..#.....#.#.##..##.#..#.##.#..#.#..##.#.##.######
#..##...##...###.###..##.#.....#..#.#.#.###..#......#...##.#...####.##..#...##..#...####.##....##.#.
##.#.###.###.#.#.....#.#.##..###.#####.#.#####.###.##.##.##.##.....#...####.....#.#....#.###.#.#...#
.#.#..#.###.##.###.#......#..#..##.##..#.#..#......#.##.#..#......##.##.##...#.##.....#...#.##..#..#
###....####.###.#.#.#...#.###.#####.##.###.#...#.#.#..#.##..#..##.....####.#.##..##..#.###..###..#..
##.##..####...#......#..##..#..#.#.......###..####..#...##..####..#####....##.#..#..###...#####.....
####..##.#...#.####..#####..#..#..###.#.##.#.###..###.#....#..#.#.#.#..##.#...#..#.####....#......#.
#.####.##.##.####.#..#..#...##.##.##....#########....#.#.###.#.#.#.......#..#####.##...#..#....#.#.#
..##.###..####.#.###.#.#...##..#.###..####.##..#.......##.##..#..#####.########..####.#..###.#..####
#..##...###....##.#...#.#..###....##..####..#...##.####.###..##......####..#..#...#..#....#.##.#.#.#
#.##..#......##....##.#.#..##..#.#...#.##..#.#.#.#####.#.##...###.#.#.####..###.###.#.....#....#..##
.####...#...####...##..###...##..####.####...#.#.#.....#####.##..#.#..#..#..#.....#.#..##......#.#.#
.....#....#..#.#.####.#.#..#..#.##...#....#####.###.###.####.##..####.#..#####..#...###.#..#.#.###.#
#.###..#....####.##..#.....#...#.#.##.###..#.....#..#.#.#####.##.####.#.###..###.....#.##.##.#.##..#
..##..#..#####..#...#.#.#..###...#.#.####.###....#.##.#...#.##.##...##.#.####...#..###.#..#.#.##..#.
.#.##...###...####.#..##.#.#####.#....#..#..#.##..###..#.#..##.#..#...####.#.####.#..##..#.#####...#
#.####...##...#.##.####.###..#...####.###...#..#.#..#.####.##...#.#....#.#..#.#.###.#.###.###.###...
.#.#.....#....###.#..#.#.##.##....#.#..##....###..###...######.##..###..#####...#..##..###.#.#.###.#
#..#.#.#...##..##.#....#.##.##..##.###.###..###.....#...##..#..#######..##.#.##.##..#.#.#.#.#.#.####
.#.#.....#...#...#.####.....##...#.##..###.####.#.#..####.#####...#..#.....##..#..##...##..#########
..##.#.....#.#.###.#.#..##..#.#.#..#..###.#.#..####..##.####..#...##.#.#.###..##...#..##.##...#..#.#
.######.####...#.#..#.#.###.##...#.##.#.##.#..##....#..#.#..#.#.##...#.#....##..##...#.#.##.#.#.#.#.
..##...###.#.#.#......#.#.###.##...#.###.#.##.#....####.###..#.##...#..#..###.#.####..#....####.##.#
##.#.###.#.##......##.####.#..###...#..#..#.#..##.#.#..#.###..#..##..#.#...##..##.##.###.##.....####
#...#..#.######.#.#...#.##.##....###.##..#..###..##.###.....##.#########..##..#....#...#.##.#....##.
#.######.#.##.###...##..##...#..##...####.#.#.....##.#.##.####..###.##..##.#.####...###.#.#.####.#.#
#####..####....#.##..##...#..#...#####...#.#..#...#.#####.#.....####..#..####.######.##.#....###.#.#
##.#.#..####.#.......#...##..#.#..#..#..##..####.####...#......#.#....###.#.#.....##..#.#.#..#...#.#
......###....#.......#.#.#...##...###.#...##..##..#..##...#.#.##.##.###...##....#####...#####.#..##.
.##..##.##..#.##....#..#.###..#.###..#.#.##..###....##.###..#.#.##.#...#.##.#.#.###...#.#...#...#..#
..#.....#.#.#...###.#.##.....###...##.####...##.#.#.#..##.#..#....#.##.##.##..#.#.##..###.#..#####..
#...#..#.......##..###.#...##..####.###.....###..####.....#..#.####...#..#.#......##..##.##..##.#..#
.#..#...#########.....###...##..##..##.##.###......##.####.####.....#..##.#.###.##...#.#....#.######
#..#..#....###.##.#...##.#..#...#.##...#.###...#..#####.#.##.#....####..###.#.#.#...##..##.....#..#.
####.#..#.........######..#...#.##.###.###....#...#.#.#.##..#.####....#####.......##....#..#....####
#....##.#.###.#....####.##...#####......#...#..#.#..####.##..###########..##.##....#...#..####..##..
#.#..#.#..#.####......##..#.#.#.#......#.##.####.#..###.###..#.#...##.#.#..#.#.##..#....###.#.###.##
..#..##...#####.##.###########..###.##.##...#.........###..#.##.#.###....#..####..###.#....#...#####
...#....#.....###.....##.#.###..#..#####..#.....###.....#..##..#...#.##.###....#.#####.....#.###.###
##.##..#.#.....##.#..#####.####...#.#.#....####.#.###.###.##......#.##...#...#...#.#.#.####..#.####.
##..#...###.#.#..##..###.#.#...##.#.#.....#.#.####.##.##.#..##....#.##.#####.#...#.#.##....###.#.#.#
###.....#.#..#####.#..###...####....#.#..#..#.##.#.#...##..#.#.#..###....#.#.....##.#.#.######.##.##
#####..#..#.#.##..#..##.##..##.####.#.....#....#########.#######.##.###.#..#.#....#....#.##.######.#
#......####.#...##.#...###..##.######..##..#...####....#...###.##..#.###..##########..#.##.##.#.#..#
####...##..#..#.....#..#...##..##.####........#..##...#..#...#####.#.#.......####..##.##.###.##.#.##
.##..##......##.##....##..#..#.#.#.....#####.#...####..######...##.##..#.#..#.##.#.##.##.#####.##...
..#..#####....####.##.###..#...#..##.####.##.###...##.....#.####...#.#..##.#..##.###.##....#.#.#..#.
#.#.#.#.#..#...#.####...##.#..#..###.####..#..##..#.......#..#.##.#...####.####..#.##..##..#.###.###
..#...#...####...#..###.###.....#....#.#.##.####..#....###...###..#.......###....#.#.#.#...#..###.#.
.###...#############.#####.##...#.#.#.#.#..##.....####.###.#...#.####..#....#...#.#...###.#.#.##.#..
..#.#....#..#....#####.####..##..#..#.#..####.###..#.#.##.########....#.#....#########....#.#.##.#..
.#...#.###.#.#.#####.###.##.#####...##.....##...####.##.#####....###...#.#.#.#####.###.###.###...#..
#.#####...#.##.#.##...#....###.#..####.##..#..#..###.#.###..#.#.....#..#.#.#.####.#.......#.###....#
.######.#.##....###.###.####...#...#######..#.#.#...###...#........#.###.#####..##..###.####...#.###
#...##..##...###.#.#.##.##.#....#....#.#.##..###..##.#.#..#..#...#...######.#..###..#.#..#.#..#....#
...####..##.#..###.##.#.#.##.#....#.....#...#####....#..###....#.#.#....##.########..##..##.#.##.#.#
.####.######..####.###...#####.##.####..#..##..##.#.#.#.#.#.###...##......#..#####.#..##.#.####....#
##.#.#.##....#..#.##.#...######.###..#####.....#..#.#..#.#..#..##.#.#.#.##.#..#..##.##.#......#####.
.###......##.#..##.#.....#..##..##....#....########.#.##.####..##..#########...##..#.#..#.##....#.##
.###.#.####.#########....#....#.###...###..#########..#..########.#..###.###.#..#..#.##.#....#..#.##
..#..######...##...#.#...#..#...#.....##...#.#.#...##..#.##.##.#.##..#.......##.....##.#......#.###.
.#..####...#.##.#.....###..##.#.##.....#.#.###..#...#.#...###.#...##.##....#.###.#.####.#..#.....#.#
##.#..#.##.#.#.###......##...#.##.#.#.#.#...####..##....#.##.....###..#.###.#...###.##.#.....#..#.#.
###.##...###.###.###.....#####.#####.#.#..#..##...##..#.#....##..#.#.####.#.#.###.#..##.#.###..##..#
.##.#.####..#......#.#..###..######.#######.###..#####.##.#....##.###.##.##.##.#.####.#..##..#.###.#
.#..#.....###.###.#.##..#.#.#.##....##...#..#..#.##...###.#.###..###.####.#..#..#########..##..##.#.
....#...###.#.#....##..#..###..#.#.####.###.######..#.##.#...#..#.##...#...##.###..............##.##
.##..####..##....#.###......#.##.#.####..#....#..###..#.###..####..##.#.#.....###.#..#.#..#.#.....##
###.####....##..##.#..#######.#...#..#.##..#########.......#..#####..##.##..#..#..#..#..##...#..#.##
##.##.#..#.##..#..###.#..#.####..#.#.#....#.#..####.#...#..####.#####....###.##....#..##..#..#.###..
.....#.#..###..##....###.......#.######....##.#..##....#..###...#..##.##.#.....#..###...##......###.
..#.#...#.....#...#....##.#.##.#.#.#.###.#..#....###.....#.#......#....##..##.##.####.##.#####.#...#
..##..#.#..###..#..##..##...#..##..#...###..##.#...#..#...##.###.##.##.#.##...#.##......###.#...##..
.####..###.#..#.###...#.##........#.##.#..#.#..###.##..##.#....#.#.#..##...#..#.####....#.....##...#
#.......###....##..##.#.#..#.#..##.##...#.#.#.#.#.#..###.#...#..###.########....#.#######..#.##..###
#..#.####..#.##.#...####....##.######.####...####..#.####...........#.##..###..#....#.##..#.#...###.
..####....#.#.##.#.###...##..#.###..#......####.#.##.##.#..#.#..###.##...#..#.##.###..###.###.###..#
..#....#.###..#.#...#.####.########.####..#.#.#....#.#.##.##...####.#.##..##.#.#.##.##.#..#..#..##.#
.##.#...###.###..#..###.#..####.#...#.#..##.##.###...#.###.#..##.#.##......#..##..##.#.#.#.#.##.###.
#######.##.#####.#..#....##..#.###..#..##.######.....##.#....###..###.#.#...##.####.#.#....#..#..###
.##.###.####...##.#......#..#..#####...###.###..##..####.#....#...#..###..######..##.##.####....##..
.#.....#...##...##.#.######..####.....#.#.#####....#..##....#..#...###.#.##.#.#......#.######.#.#...
#####.#....#..#.#.##...##..#.#...#.#.#.##.##.#.#####.#..#.#...######.........###....#.##.###.#.#.#.#
....#...##.#.###..#######.##..####.###....#.####...####.#..####.#.####...#.#....#.##...#.##.##..##..
#..#.#####.#####..###.#.....#.#.#.##......#.#..###......#...#.####.#..##.#.###...#.#.......###.####.
##..###...#..........#..#.###.##.##..##.#...##..#.#...##.#..#.##...##..####.######.#..#.####.#.#####
..######..#...##.#.#....#.##.#.#.#.#..#..###..###..##..##..#.....#.#.###.##.#.#.#.###..##....#..####
#.#.####.#.....##..#..#.#.#.##..#.#.#######.#....###.##...##.##.#.#..##..#......######.#....#....#..
`.trim().split('\n')

console.log(countLitPixel(test, algo))
console.log(countLitPixel(test, algo, 50))
