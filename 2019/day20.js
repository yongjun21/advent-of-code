const OFFSETS = [
  [0, -1],
  [1, 0],
  [0, 1],
  [-1, 0]
]

function navigateMaze (input, sameLevel = false) {
  const width = input[0].length + 2
  const height = input.length + 2
  const emptyRow = Array(width).fill(' ')
  input = [emptyRow, ...input.map(row => [' ', ...row, ' ']), emptyRow]

  const labels = {}
  input.forEach((row, y) => {
    row.forEach((v, x) => {
      if (/[A-Z]/.test(v)) {
        if (/[A-Z]/.test(input[y][x + 1])) {
          const label = v + input[y][x + 1]
          const distal = input[y][x + 2] === '.'
          const position = distal ? [x + 2, y] : [x - 1, y]
          labels[label] = labels[label] || []
          labels[label].push(position)
          input[y][distal ? x + 1 : x] = '#'
        } else if (/[A-Z]/.test(input[y + 1][x])) {
          const label = v + input[y + 1][x]
          const distal = input[y + 2][x] === '.'
          const position = distal ? [x, y + 2] : [x, y - 1]
          labels[label] = labels[label] || []
          labels[label].push(position)
          input[distal ? y + 1 : y][x] = '#'
        }
      }
    })
  })

  const outerPortals = {}
  const innerPortals = {}
  Object.keys(labels).forEach(label => {
    if (label === 'AA' || label === 'ZZ') return
    const [a, b] = labels[label]
    if (a[0] === 3 || a[0] === width - 4 || a[1] === 3 || a[1] === height - 4) {
      outerPortals[a] = b
      innerPortals[b] = a
    } else {
      outerPortals[b] = a
      innerPortals[a] = b
    }
  })

  const orig = labels.AA[0]
  const dest = labels.ZZ[0]

  const visited = {}
  const unvisited = []
  unvisited.push([...orig, 0, 0])
  while (unvisited.length > 0) {
    const [x, y, z, steps] = unvisited.shift()
    const key = [x, y]
    const key2 = sameLevel ? [x, y, z] : key
    if (key2 in visited) continue
    visited[key2] = steps
    const v = input[y][x]
    if (v === '#') continue
    if (x === dest[0] && y === dest[1] && (!sameLevel || z === 0)) return steps
    OFFSETS.forEach(offset => {
      unvisited.push([x + offset[0], y + offset[1], z, steps + 1])
    })
    if (key in outerPortals && (!sameLevel || z > 0)) {
      unvisited.push([...outerPortals[key], z - 1, steps + 1])
    }
    if (key in innerPortals) {
      unvisited.push([...innerPortals[key], z + 1, steps + 1])
    }
  }
}

const test = `
                                   G           R   U       E         Z S       S                                       
                                   W           N   C       K         Z G       D                                       
  #################################.###########.###.#######.#########.#.#######.#####################################  
  #.#.......#.#.........#.#.#.....#.#.....#.#.#...#.....#.........#.....#...#.#...........#.......#.....#.....#.#...#  
  #.#####.###.###.###.#.#.#.###.###.#.###.#.#.###.#.###.###.#####.#.###.###.#.###.#########.###.###.#######.###.#.###  
  #.#.#.#...#...#.#.#.#.................#.#...#...#.#.#...#.#.....#.#.#.#.....................#.#.......#.........#.#  
  #.#.#.#.###.#####.#########.###########.#.#.#.###.#.#######.###.#.#.#####.###.#.###.#.###.#.###.#######.#######.#.#  
  #...#...#.#.#.#.........#...#...#.......#.#...#.......#.....#.#.#.....#.....#.#...#.#.#...#.#...#.#.........#.#.#.#  
  #.#.###.#.#.#.#####.#.#.#######.#.#######.###.#.###.#####.###.#####.#.###.#########.#.#.#######.#.#####.#####.#.#.#  
  #.#...#.#.#.#.#.....#.#.................#.#...#.#.#.....#...#.#.#...#...#.#.....#.#.#.#...#.#.#...........#.#.....#  
  ###.###.#.#.#.#.#.#####.#.###.#########.#.#######.#.#####.###.#.#.#.#####.#.#.###.#.#######.#.#.###.#######.###.#.#  
  #...#.......#...#.#.#.#.#...#.#.........#.....#.......#.#.......#.#...#.....#.....#.#...#.........#...#.#.#.#.#.#.#  
  ###.#######.#######.#.###########.#.#####.###.#####.###.#.#####.#.###.#.#.###.#.#######.###.#####.#####.#.#.#.#####  
  #.......#.#...#.......#.........#.#.#...#.#.#.#.....#.....#...#.#...#.#.#.#...#...#...#...#...#.#.#...........#.#.#  
  #.#.###.#.#.#########.#########.#.###.###.#.#####.#.###.#.#.#.#.#.###########.#.###.###.###.###.###.###.#.#####.#.#  
  #.#...#.....#.#...#.#.#.#.#.............#.....#...#...#.#.#.#...#...#.#.#.....#.........#...#.......#...#...#...#.#  
  ###########.#.#.###.#.#.#.#######.#####.#.#####.#.#######.#####.###.#.#.#####.#.#.###.#####.###.#############.#.#.#  
  #.#.#.#.#.....#.#.....#.#.#.#.....#...#.#.....#.#.....#...#.#.#...#...#.#.#...#.#...#...#...#...#...#.#.......#.#.#  
  #.#.#.#.###.###.#####.#.#.#.#####.#.###.#.#########.#######.#.#.###.###.#.#.###.###.#####.#####.#.###.#####.#####.#  
  #.#...#.#...#.#.#...#...#.#.....#.#.....#.#...#.....#.......#.#.#...#.....#.#.#.#.......#.......#...#.#.#...#.#...#  
  #.#.#.#.###.#.#.###.#.###.#.#####.#.###.#.###.###.###.#.#.###.#.#.###.#.#.###.#.###.#####.#.#####.###.#.###.#.###.#  
  #.#.#.#.#...#.#...#...#.#.#...#...#...#.#.#.....#.#...#.#.#.....#.#...#.#.#.......#.......#...#.#.....#.........#.#  
  #.#.###.###.#.#.#####.#.#.#.###.#.#####.#.#.###.#.###.#.###.#.###.#.###.#####.#####.#####.#####.###.#########.#.#.#  
  #.....#...#.......#.#.#.......#.#.#...#.#...#.#.#.....#...#.#...#...#.#...#.......#...#.#...#...#...#.#.#.#.#.#.#.#  
  ###.###.#######.###.#.#.#.#.#########.#.#####.#.#.#####.#######.#####.#.#####.#.#.###.#.#######.###.#.#.#.#.#.###.#  
  #.....#...#.#.#.......#.#.#.#.#.......#...#.....#.#.....#.......#.......#.#...#.#.#.#...#.....#.#.....#.#.#...#.#.#  
  ###.###.###.#.#######.#.#####.#####.#.#.###.#########.#.###.#.#####.#####.###.#####.#######.###.###.###.#.#.###.#.#  
  #.....#.......#...#...#...#.#.#.#.#.#.#.#.......#.#...#.#.#.#...#.......#...#.......#...#.....#...#.#.........#...#  
  #.#####.#######.###.#.#.###.#.#.#.#.#.#.###.#.###.#.#####.#####.#####.#####.###.#######.###.###.###.#########.#.###  
  #...#...#...#.#.#...#.#.#.#.........#.....#.#.....#.......#.......#...#.............#...#...#.#.........#...#.#...#  
  #.###.###.###.#.#####.#.#.#.#####.#############.#######.#####.#####.#######.###########.###.#.###.#######.###.#.###  
  #...#...#...#...#.#...#...#.#    S             L       B     V     G       R          #.#.#.#.....#.#.......#.#...#  
  #.###.#.#.#####.#.###.#.###.#    D             M       E     H     X       Q          #.#.#.#####.#.###.#####.#.###  
  #.....#.#.................#.#                                                         #.........................#.#  
  #.###.###.#####.#.#.#.###.###                                                         #.#.#.###.#######.###.#.#.#.#  
  #.#.#.....#.#...#.#.#.#.....#                                                       RZ..#.#...#.....#.#...#.#.#.#..BE
  #.#.#####.#.#####.#.#####.###                                                         #######.#####.#.#.#######.#.#  
  #.....#.#.....#.#.#.....#.#.#                                                         #.#.#.#.#.#...#.......#...#.#  
  ###.###.###.#.#.#.#.###.#.#.#                                                         #.#.#.###.#####.#.#######.#.#  
RI....#.....#.#.#...#.#.#.#....UW                                                       #.#.......#...#.#.#.#...#...#  
  #####.###############.###.###                                                         #.###.#####.#.#####.#.#.#####  
  #.....#.#.#...#.#.....#.#...#                                                       GW..........#.#.........#.#...#  
  #.###.#.#.#.###.###.###.#####                                                         #.###.#.#.###.#######.###.###  
  #...#...#.....#.#.......#....FM                                                       #.#...#.#.....#...#.........#  
  ###.###.#.#.#.#.#.#########.#                                                         ###.#######.###.###########.#  
AJ..#...#...#.#...#...#.....#.#                                                         #...#.#.#...#...#.#...#.#.#..GX
  #.#.#########.#.#.#######.#.#                                                         #####.#.#######.#.###.#.#.###  
  #.....#.#.#.#.#.............#                                                         #...............#...#........DD
  #######.#.#.###########.###.#                                                         ###.#######.###.#.#.#.#.###.#  
  #.....................#.#...#                                                         #.......#.....#...#.#.#.#...#  
  ###.###.#.#.###.#####.#######                                                         #####.#########.###.#.###.###  
GP..#...#.#.#.#.....#.#...#...#                                                       SG..#...#.....#...#.#.....#...#  
  #.###.#####.#.#.#.#.###.###.#                                                         #.#.###.#.#######.#######.###  
  #.#.....#.#.#.#.#.#.....#...#                                                         #.....#.#.#.#...#.#.#...#.#.#  
  #.#.#####.#########.#######.#                                                         #########.#.###.#.#.#.#####.#  
  #.....#...#..................SI                                                     DD....#........................UW
  #.#######.#####.###.###.#####                                                         #.###.#####.#.###.#.###.#####  
  #.#.#...#...#.....#.#.#.#.#..AJ                                                       #.........#.#.#.#.#.#.....#.#  
  ###.#.###.#.#########.###.#.#                                                         #.#####.###.#.#.#######.###.#  
  #.........#.#...#.....#.#.#.#                                                         #...#.....#.#...#.#.#.#.#....LM
  #########.#.###.#.###.#.#.#.#                                                         #########.#.#.###.#.#.#####.#  
AA......#.#.#.....#.#...#.....#                                                         #.#.#.#.#.#.#.#...#.#.#.....#  
  #.#####.#.#.###.#.#.###.#.###                                                         #.#.#.#.#########.#.#.#####.#  
JO..........#...#...#.....#...#                                                         #.#.......#.#.............#.#  
  #####.###############.###.#.#                                                         #.#.#.#####.###.###.#.###.#.#  
  #.#.#...#.........#.#.#.#.#.#                                                       TX....#.............#.#...#...#  
  #.#.#######.#.#.#.#.###.###.#                                                         #.###.#.###.#####.###########  
VH......#.....#.#.#.....#...#.#                                                         #.#...#.#...#...#.#.....#...#  
  #####.#.###########.###.#####                                                         #############.#####.###.#.#.#  
  #.....#.....#.#.......#.....#                                                         #.#...#...#.#.......#.#.#.#..RZ
  #.#.#######.#.#######.#.#####                                                         #.###.###.#.###.#.###.#.#.###  
  #.#...........#.#............FW                                                     RN..#.....#...#.#.#.#.....#...#  
  #########.###.#.#.###########                                                         #.#.#.###.###.###.#.#####.###  
  #...#...#.#.....#.#.........#                                                         #...#.............#.......#.#  
  #.#.#.#################.#.#.#                                                         ###############.###########.#  
AX..#...#.#...#.#...#...#.#.#..HR                                                     JO............#.#.#...........#  
  #.#.###.###.#.#.#####.###.#.#                                                         #.#.#####.#.#.###.#.#.#####.#  
TX..#...#.......#...#.....#.#..EK                                                       #.#...#.#.#.......#.#...#.#..MM
  ###.#.###.#.#.#.#.###.#.#.###                                                         #.###.#.#######.#.###.###.#.#  
  #...#.....#.#...#.....#.....#                                                         #.#.#.....#.#...#...#.#.....#  
  #####.#.#.#####.###.#######.#        R     Y   G           U     A           M S      #.#.#.#.###.#####.#.#.###.#.#  
  #.....#.#...#.....#.....#...#        I     Q   P           C     X           M Y      #...#.#.#.....#...#.#...#.#.#  
  #####.#########.###.#####.###########.#####.###.###########.#####.###########.#.#######.#.###.#.#########.#.#####.#  
  #...#...#.#.......#.....#...#...#.....#.....#.....#.#.....#...#...........#...#...#...#.#.#.....#.#.......#.#.....#  
  #.#.#.###.###.#.#.#######.#####.###.###.###.#####.#.###.#.#.#########.#####.#####.#.#########.###.###.#####.###.#.#  
  #.#.......#...#.#.#.......#.....#.#.#.....#.#.....#...#.#.......#.#.#...#.......#.#.......#.#.#.#.....#.......#.#.#  
  #.#.#.#.#####.###########.#####.#.#.#.#.#.#####.###.###.#########.#.#.#######.###.#.#######.###.###.#.###.#.#.#.#.#  
  #.#.#.#...#.......#.......#.........#.#.#.....#.#.....#.........#.........#.#.#.....#.......#.......#.#.#.#.#.#.#.#  
  #######.#.#.#.#####.#.#########.#############.#.#.###.#######.#####.#.#####.#.#.#######.#####.#.#.###.#.#.#######.#  
  #.......#.#.#...#...#.#.........#.......#...#.#.....#.#.......#.....#...#.....#...........#.#.#.#.#.....#...#.....#  
  #.#.#.#####.#.#.#####.#.#######.#.###.###.###.#.###.#.#.###.#.#.#.###.#.#####.#.###.#.#.###.###.#.#.#.#####.#####.#  
  #.#.#.#.....#.#.#.....#...#.#.....#...#.......#.#...#.#...#.#.#.#...#.#.#.....#.#...#.#.......#.#.#.#...#.#.#.....#  
  #.###.###.#.###.###.#.#.###.#.#.#.#.###.###.#.#######.###.#.###.#######.#.#.#.#####.#.#.#.#############.#.#####.###  
  #.#.#.#.#.#...#.#...#.#.#.....#.#.#...#...#.#...#.....#...#...#...#.....#.#.#.....#.#.#.#.#.....#.#.#.......#...#.#  
  ###.#.#.#.#.###.#####.#############.#.#.#.#.#######.###.###.###.#############.#####.#####.###.###.#.#.#####.###.#.#  
  #.......#.#.#.....#...#.#.......#...#.#.#.#.#.#.#.#...#...#.#.....#.#.#...#.....#.#.#...#...#.......#.....#...#...#  
  ###.###.#.###.#########.#######.#####.#.#####.#.#.#.###.#######.###.#.#.#####.###.#.#.###.###.#####.#.#.###.###.###  
  #.....#.#.#.....#.....#.#.......#.#.#.#...#.......#.#.......#...#.....#.......#.........#.#.#.....#.#.#.#...#.....#  
  #.#####.#.###.#.#####.#.#######.#.#.#.#.#######.#.#.###.#####.#.###.#.###.#.#####.###.#####.#.#######.###.#.#.#.###  
  #.#.....#.#...#...#.......#.#.....#...#.#.#.....#...#.......#.#.....#.#...#...#.#...#...#.#.#.....#.#.#.#.#.#.#...#  
  #####.#.#.###.#######.#.###.###.#.#.###.#.#####.#######.#######.#.#####.###.###.###.#####.#.#.#####.###.#######.#.#  
  #.#.#.#.#.#.#.#...#...#...#.#.#.#...#.......#.#.....#.#.#...#...#.....#.#.......#.........#.#...#.#.........#.#.#.#  
  #.#.#######.#####.#####.###.#.#.#########.###.#####.#.#.#.#######.#########.#.###.#########.###.#.#.#########.#.#.#  
  #...#.#.#.#.....#.#...................#...#...#...#...#.....#...#.#...#...#.#.#.....#.#.......#.#.#.#.#.#.#...#.#.#  
  ###.#.#.#.#.###.#.#####.#############.###.#.#.#.#.###.#.#.#####.#.#.#####.###.#.###.#.#####.###.#.#.#.#.#.###.#.###  
  #...........#.#.#...#...#.#.......#.#...#...#.#.#...#.#.#...#.#.......#.....#.#...#.#.#.#.#.....#.....#.#.....#...#  
  #####.#.#.#.#.###.#####.#.#.#.###.#.#.#######.#.###.#.#.###.#.#####.###.###.#.#.###.#.#.#.#.#####.###.#.#.#########  
  #.#...#.#.#.............#...#...#...#.....#...#...#...#.#.#.#...#...#...#.#...#.#...................#.............#  
  #.#####.#######.#.###.###.#.#.#####.#.#######.###.#####.#.###.#.#.#####.#.###.#.#.#####.###.#####.###.#.###.#.#####  
  #.......#.......#...#...#.#.#.#.........#.....#.....#.......#.#.......#.....#.#.#.....#...#.....#...#.#...#.#.....#  
  ###################################.#######.###.#########.#######.#########.#######.###############################  
                                     Y       S   R         S       F         F       H                                 
                                     Q       Y   Q         I       M         W       R                                 
`.split('\n').slice(1, -1).map(line => line.split(''))

console.log(navigateMaze(test))
console.log(navigateMaze(test, true))
